- システム規模のテストを書くことを好む
	- 小さいテストより時間がかかり、信頼性が低く、デバックが難しい
- 小さいテストとは？
	- 定義がない
	- 規模（size）と範囲（scope）
		- 規模
			- テストケースの実行に必要なリソース、メモリー、プロセス、時間
		- 範囲
			- 検証している特定のコードパス

### テスト規模

- テストがどのように動作するか
- テストが実行許可されているのはどんなことか
- どれだけのリソースをそのテストが消費するか
- 小テスト
	- 単一のプロセス内で実行される
- 中テスト
	- 単一のマシン上で実行される
- 大テスト
	- 任意の場所で実行される

- テストスイートの重要な特性
	- 速度と決定性

#### 小テスト

- 制約
	- 単一のプロセス内で実行されなければならない
	- sleepできない、I/O操作を実行できない、他のあらゆるブロックする関数呼び出しができない
- 非決定性に失敗すると[信頼不能テスト](https://testing.googleblog.com/2016/05/flaky-tests-at-google-and-how-we.html)になる
- テストの大小に関係なく、可能な限り小テストを書くよう努める

#### 中テスト

- 制約
	- 複数プロセスに広がることができる
	- localhost以外のシステムへネットワーク呼び出しを一切許可しない
- テストが遅くなり、非決定性になる可能性が増す

#### 大テスト

- 制約
	- 複数マシンにまたがることもできる
	- 柔軟性が増すが、リスクも増す
- E2Eテストで、コードより設定の検証用であるもの
- テストダブルの利用が不可能なレガシーコンポーネントのテスト向けに確保されている

#### 信頼不能テスト

- たまに失敗するテストのこと
- コストが高い
- 0.1%程度にとどめておくべき

#### 共通の属性

- 全てのテストは密閉された状態となることを目指すべき
- 実行順等の外部環境について前提条件はできるだけ持つべきではない
- 共有データベースに依存すべきではない
- テストは当該挙動を実行するのに必要な情報のみ含むべき
	- テストを明確かつ単純に保てばコードが何をするか分かる
	- テストは検証時に明白であるべきだ
- テスト内で条件分岐やループはアンチパターン
	- https://testing.googleblog.com/2014/07/testing-on-toilet-dont-put-logic-in.html
	- 比較的複雑なテストのフローはそれ自体バグを含むリスクがあり、テストの失敗原因を確定するのが難しくなる
- テストは書くことより読まれる事が多いので、自分が読みたいようなテストを必ず書くべき

### テスト範囲

- 狭い範囲のテスト
	- ユニットテスト
- 中範囲のテスト
	- インテグレーションテスト
- 大範囲テスト
	- ファンクショナルテスト
	- エンドツーエンドテスト
	- システムテスト
- テスト対象システム外のコード実行を避けるためにテストダブルを多用するもの
	- https://martinfowler.com/articles/mocksArentStubs.html#ClassicalAndMockistTesting
	- Googleでは可能なら本物の依存関係をその場に置いたままにしておく方を好んでいる

- ピラミッド型のテストピラミッド
	- アンチパターンとしてアイスクリームコーン型
	- 砂時計型

#### Beyonceルール

- 破綻してほしくないもの全部をテストせよ
- Beyonceルールとは
	- そんなに好きならそいつにテスト付けときゃよかったのに
- 障害に備えたテスト
	- 一般的な障害をシミュレートする自動テストを書くべき
	- [カオスエンジニアリング](https://en.wikipedia.org/wiki/Chaos_engineering)

#### コードカバレッジについて

- カバレッジ計測は小テスト推奨
- カバレッジ率をゴールにすると、そのカバレッジを天井として扱い始める
- システムが適切にテストされているかについて批判的に考えることの代用にはならない
