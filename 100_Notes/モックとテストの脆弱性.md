## モックとスタブの違い

![[mock.png]]

- モックは、外部とのやりとりをエミュレートして検証するのに役立つ
- スタブは入力されるインタラクションをエミュレートするのに役立つ

![[moc_stab.png]]

- モック
	- スパイは手書きで書く
	- モックはモッキングフレームワークの助けを借りて作成する
- スタブ
	- ダミーはNULL値や架空の文字列など、単純でハードコードされた値
	- スタブはさまざまなシナリオに応じて異なる値を返す
	- フェイクはまだ存在していない依存関係を置き換えるために実装される
- 重要なのはモックとスタブの相互作用の流れ
	- スタブとモックの違いを理解することによってテストコードを読む助けをしてくれる

### スタブとのインタラクションをアサートしない

あるメソッドの中で呼ばれるメソッドをスタブ化し、スタブ化した値が正しく返る（呼び出しを検証する）ようにしてしまうとテストが脆くなってしまう。

### モックやスタブとコマンドやクエリの関係性

- コマンドを代用したテストダブルはモックになる
- クエリを代用したテストダブルはスタブとなる

![[command_query.png]]

## 観測可能な動作と実装詳細

- public API vs private API
- 観測可能な動作 vs 実装詳細
	- クライアントが目的を達成するための操作を公開する。操作とは、計算を行うか、副作用を発生させるか、またはその両方を行うメソッド
	- クライアントが目標を達成するのに役立つ状態を公開する。状態とは、システムの現在の情報
		- この２つのどちらも行わないコードは実装詳細になる
- よく設計されたAPIはpublicAPI x 観測可能な動作、privateAPI x 実装詳細と分離しているが、public APIに実装詳細が漏れ出している場合もある

### 適切に設計されたAPIとカプセル化

- カプセル化とは、不変性の違反として知られる不整合からコードを保護する
	- 不変性とは常に真であるべき条件のこと
	- [Tell-Don't−Ask](https://martinfowler.com/bliki/TellDontAsk.html)
- 良いユニットテストと設計されたAPIは本質的に繋がりがある
- 最小限の操作と状態を公開すること

## モックとテストの脆弱性の関係

### ヘキサゴナル・アーキテクチャ

- アプリケーションサービスは、APIを例にすると
	- DBに問い合わせ、そのデータを使ってドメインクラスのインスタンスを生成する
	- そのインスタンスに対して操作を実行する
	- その結果をDBに保存する
- ということを行う

- 各層のAPIをうまく設計すると、テストもフラクタル構造になる。
- 外部のクライアントが設定した包括的で粗い目標を、このサービスがどのように達成するか確認する
- ドメインクラスを対象としたテストでは、より大きな目標の一部であるサブゴールを検証する


![[fractal_test.png]]