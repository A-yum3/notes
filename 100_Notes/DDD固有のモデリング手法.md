## 集約

### 集約とは

- 「必ず守りたい強い整合性を持ったオブジェクトのまとまり」を表す

### 設計/実装時のルール

#### 強い整合性確保が必要なものを１つの集約にする

![[Pasted image 20220420230102.png]]

部の承認状態と部員の数は、強い整合性確保が必要になる。
集約のオブジェクトを扱うときの親となるオブジェクトを集約ごとに1つ決め、そのオブジェクトを「集約ルート」と呼ぶ

#### トランザクションを必ず１つにする

- 1つの集約のオブジェクトは、**必ず集約単位でリポジトリから取得し、集約単位でリポジトリに渡す**
	- そして、１トランザクションで集約内のすべてのオブジェクトを更新する
	- 集約の中の一部オブジェクトのみの取得/更新は許可しない
- 目的
	- 集約内のオブジェクトの整合性が崩れるのを防ぐこと
	- 部オブジェクトに部と部員を合わせた状態管理の責務を持たせ、部員を外部から直接操作できないようにすれば整合性を保てる

### 集約の境界の決め方

- DDDの設計で非常に難しい
- 複数の観点から総合的なバランスを踏まえて判断しなければいけない
- 具体的に２つの観点がある

#### 整合性を確保する必要性の強さ

- 整合性を「強く」確保したいものを１つの集約にする
- 複数集約間の整合性を確保するには、実装上のコストや難易度が上がる

#### トランザクションの範囲の適切さ

- 集約内のオブジェクトは必ずまとめて取得して1つのトランザクションで更新する
- 集約範囲が大きすぎると大きなロックをとりすぎる

## 境界づけられたコンテキスト

### 境界づけられたコンテキストの概念

> 特定のモデルを定義・適用する境界を明示的に示したもの。代表的な境界の例は、 サブシステムやチームなど。

#### モデルの共有

- エンジニアと販売部がイメージする「商品」と配送部がイメージする「商品」は異なる
- システムが大規模になると、関係者すべてで統一したモデルを作ることは難しくなる
- **モデルが適用される範囲を明示的に定義し、それぞれの中でモデル、言語の統一を目指す**

### 境界づけられたコンテキストの実装

- アーキテクチャ後

## Q&A

### DBへの意識

- DB構成を意識してしまう
	- NoSQLのデータストアと想定して考えてみる

### 集約とトランザクション

- 集約に関しては、どうしてもトランザクションに関する検討が切り離せない
- 集約に関しては、モデリング時に決め切ろうと考えずに、実装してからまたモデルに戻ってきて試行錯誤する